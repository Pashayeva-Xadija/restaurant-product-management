<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Restaurant ‚Äì ≈û…ôkilli Sad…ô UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f7f7fb; }
        .navbar-brand { font-weight: 700; }
        .card img { object-fit: cover; height: 160px; }
        .placeholder { background: repeating-linear-gradient(45deg,#eee,#eee 10px,#f7f7f7 10px,#f7f7f7 20px); display:block;width:100%;height:160px; }
        .admin-only { display: none; }
        .price { font-weight: 700; }
        .muted { color:#6c757d; }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
    <div class="container">
        <a class="navbar-brand" href="#">üçΩÔ∏è Restaurant</a>
        <div class="ms-auto d-flex gap-2">
            <button id="btnOpenLogin" class="btn btn-outline-primary btn-sm">Giri≈ü</button>
            <button id="btnLogout" class="btn btn-outline-secondary btn-sm" style="display:none;">√áƒ±xƒ±≈ü</button>
        </div>
    </div>
</nav>

<div class="container py-4">
    <div id="globalAlert" class="alert alert-info py-2 small" role="alert" style="display:none;"></div>

    <div id="adminPanel" class="admin-only">
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">Yeni m…ôhsul …ôlav…ô et</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Ad</label>
                        <input id="pName" class="form-control" placeholder="M…ôs: Latte">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Qiym…ôt (AZN)</label>
                        <input id="pPrice" type="number" step="0.01" class="form-control" placeholder="6.50">
                    </div>
                    <div class="col-md-5">
                        <label class="form-label">Kateqoriya</label>
                        <select id="pCategory" class="form-select">
                            <option value="">‚Äî se√ßin ‚Äî</option>
                        </select>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">A√ßƒ±qlama (opsional)</label>
                        <input id="pDesc" class="form-control" placeholder="Qƒ±sa t…ôsvir">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">≈û…ôkil URL (opsional)</label>
                        <input id="pImage" class="form-control" placeholder="https://...">
                    </div>
                </div>
                <div class="mt-3">
                    <button id="btnAdd" class="btn btn-primary">∆èlav…ô et</button>
                    <span id="addMsg" class="ms-3 small"></span>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex align-items-center justify-content-between mb-3">
        <h4 class="m-0">M…ôhsullar</h4>
        <div><button id="btnRefresh" class="btn btn-outline-secondary btn-sm">Yenil…ô</button></div>
    </div>

    <div id="productsRow" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3"></div>
    <div id="emptyState" class="text-center text-muted my-5" style="display:none;">H…ôl…ô m…ôhsul yoxdur.</div>
</div>

<div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0">
        <div class="modal-header">
            <h5 class="modal-title">Giri≈ü (JWT)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <div class="mb-3">
                <label class="form-label">Email</label>
                <input id="email" class="form-control" placeholder="admin@example.com">
            </div>
            <div class="mb-2">
                <label class="form-label">≈ûifr…ô</label>
                <input id="password" type="password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div id="loginMsg" class="small muted"></div>
        </div>
        <div class="modal-footer"><button id="btnLogin" class="btn btn-primary">Daxil ol</button></div>
    </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const PLACEHOLDER_SVG = 'data:image/svg+xml;utf8,' + encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="640" height="360">
         <rect width="100%" height="100%" fill="#efefef"/>
         <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#999" font-size="20" font-family="Arial">≈û…ôkil yoxdur</text>
       </svg>`
    );

    const $ = sel => document.querySelector(sel);
    function esc(s=''){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
    function showAlert(msg,type='info'){const el=$('#globalAlert');el.className=`alert alert-${type} py-2 small`;el.textContent=msg;el.style.display='block';setTimeout(()=>el.style.display='none',3000);}
    function token(){return localStorage.getItem('token')||'';}
    function setToken(t){t?localStorage.setItem('token',t):localStorage.removeItem('token');updateAuthUI();}
    function authHeaders(){const h={'Content-Type':'application/json'};const t=token();if(t)h['Authorization']=`Bearer ${t}`;return h;}
    function updateAuthUI(){const authed=!!token();$('#btnLogout').style.display=authed?'inline-block':'none';$('#btnOpenLogin').style.display=authed?'none':'inline-block';$('#adminPanel').style.display=authed?'block':'none';document.querySelectorAll('.admin-only').forEach(el=>el.style.display=authed?'block':'none');}

    async function loadCategories(){
        try{
            const r=await fetch('/api/categories');
            if(!r.ok) throw new Error('Kateqoriyalar y√ºkl…ônm…ôdi: '+r.status);
            const cats=await r.json();
            const sel=$('#pCategory'); sel.innerHTML='<option value="">‚Äî se√ßin ‚Äî</option>';
            cats.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=`${c.id} ‚Äî ${c.name}`;sel.appendChild(o);});
        }catch(e){showAlert(e.message,'warning');}
    }

    async function loadProducts(){
        const row=$('#productsRow'), empty=$('#emptyState');
        row.innerHTML=''; empty.style.display='none';
        for(let i=0;i<6;i++){const col=document.createElement('div');col.className='col';col.innerHTML=`<div class="card shadow-sm"><span class="placeholder"></span><div class="card-body"><div class="placeholder-glow"><span class="placeholder col-8"></span><span class="placeholder col-4"></span><span class="placeholder col-6"></span></div></div></div>`;row.appendChild(col);}
        try{
            const r=await fetch('/api/products');
            if(!r.ok) throw new Error('M…ôhsullar y√ºkl…ônm…ôdi: '+r.status);
            const items=await r.json();
            row.innerHTML='';
            if(!items.length){ empty.style.display='block'; return; }
            items.forEach(p=>{
                const col=document.createElement('div'); col.className='col';
                const imgSrc=p.imageUrl ? p.imageUrl : PLACEHOLDER_SVG;
                col.innerHTML=`
            <div class="card h-100 shadow-sm">
              <img src="${esc(imgSrc)}" class="card-img-top" alt="${esc(p.name||'M…ôhsul')}">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-1">
                  <h5 class="card-title m-0">${esc(p.name||'')}</h5>
                  <div class="price">${p.price!=null?esc(String(p.price)):''} <span class="text-muted">AZN</span></div>
                </div>
                ${p.description?`<p class="card-text small text-muted mb-2">${esc(p.description)}</p>`:''}
                <span class="badge text-bg-secondary">${p.categoryName?esc(p.categoryName):(p.categoryId!=null?('#'+p.categoryId):'Kateqoriya')}</span>
              </div>
              <div class="card-footer bg-white border-0 pt-0">
                <button class="btn btn-outline-danger btn-sm admin-only" data-del="${p.id}">Sil</button>
              </div>
            </div>`;
                row.appendChild(col);
            });
            document.querySelectorAll('[data-del]').forEach(btn=>{
                btn.addEventListener('click', async ()=>{
                    const id=btn.getAttribute('data-del');
                    if(!confirm(`Silinsin? ID=${id}`)) return;
                    try{
                        const r=await fetch(`/api/products/${id}`,{method:'DELETE',headers:authHeaders()});
                        if(!r.ok) throw new Error('Silinm…ôdi: '+r.status);
                        showAlert('Silindi ‚úÖ','success'); loadProducts();
                    }catch(e){showAlert(e.message,'danger');}
                });
            });
            updateAuthUI();
        }catch(e){row.innerHTML=''; empty.style.display='block'; showAlert(e.message,'danger');}
    }

    async function addProduct(){
        const name=$('#pName').value.trim();
        const price=$('#pPrice').value.trim();
        const categoryId=$('#pCategory').value.trim();
        const description=$('#pDesc').value.trim();
        const imageUrl=$('#pImage').value.trim();
        const addMsg=$('#addMsg');

        if(!name||!price||!categoryId){addMsg.textContent='Ad, qiym…ôt v…ô kateqoriya t…ôl…ôb olunur';addMsg.className='text-danger small';return;}
        const dto={ name, price:Number(price), categoryId:Number(categoryId), description:description||null, imageUrl:imageUrl||null };

        try{
            const r=await fetch('/api/products',{method:'POST',headers:authHeaders(),body:JSON.stringify(dto)});
            if(!r.ok){const t=await r.text();throw new Error(`X…ôta ${r.status}: ${t}`);}
            addMsg.textContent='∆èlav…ô olundu ‚úÖ'; addMsg.className='text-success small';
            $('#pName').value=''; $('#pPrice').value=''; $('#pCategory').value=''; $('#pDesc').value=''; $('#pImage').value='';
            loadProducts();
        }catch(e){addMsg.textContent=e.message; addMsg.className='text-danger small';}
    }

    const loginModal=new bootstrap.Modal($('#loginModal'));
    $('#btnOpenLogin').addEventListener('click',()=>{ $('#loginMsg').textContent=''; loginModal.show(); });
    $('#btnLogin').addEventListener('click', async ()=>{
        const email=$('#email').value.trim(); const password=$('#password').value.trim(); const msg=$('#loginMsg');
        if(!email||!password){msg.textContent='Email/≈üifr…ô t…ôl…ôb olunur'; msg.className='small text-danger'; return;}
        try{
            const r=await fetch('/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});
            if(!r.ok) throw new Error('Login uƒüursuz: '+r.status);
            const data=await r.json(); setToken(data.token);
            msg.textContent='Uƒüurlu giri≈ü ‚úÖ'; msg.className='small text-success'; setTimeout(()=>loginModal.hide(),400);
            loadCategories(); loadProducts();
        }catch(e){msg.textContent=e.message; msg.className='small text-danger';}
    });
    $('#btnLogout').addEventListener('click',()=>{ setToken(''); showAlert('√áƒ±xƒ±≈ü edildi','secondary'); loadProducts(); });
    $('#btnAdd').addEventListener('click',addProduct);
    $('#btnRefresh').addEventListener('click',()=>loadProducts());

    updateAuthUI(); loadCategories(); loadProducts();
</script>
</body>
</html>
